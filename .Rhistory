caldate <- firstdate:lastdate
patient_daily.df <- data.frame(mrn=targetmrn,caldate=as.Date(caldate,"1970-01-01"),
isactive=0,newhpn=0,admit=0,centline=0,nothosp=1,bloodinf=0,liver=0,
death=0,transfer=0,weanoff=0,remclabsi=0)
if (length(this.dat1$mrn)>0) {
for (svcstart in this.dat1$svc_start) {
n <- length(this.dat1[this.dat1$svc_start==svcstart,"active_current"]==0)
if (n > 1) {
warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same service start date:",
as.Date(svcstart,"1970-01-01") ))
return( NULL )
}
if (this.dat1[this.dat1$svc_start==svcstart,"active_current"]==0) {
svcstop <- this.dat1[this.dat1$svc_start==svcstart,"svc_stop"]
if (!is.na(this.dat1[this.dat1$svc_start==svcstart, "end_type"])) {
if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==1)
patient_daily.df[patient_daily.df$caldate==svcstop, "transfer"] <- 1
else if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==2)
patient_daily.df[patient_daily.df$caldate==svcstop, "weanoff"] <- 1
else if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==4)
patient_daily.df[patient_daily.df$caldate==svcstop, "death"] <- 1
}
}
else svcstop <- lastdate
patient_daily.df[patient_daily.df$caldate %in% svcstart:svcstop,"isactive"] <- 1
}
firstdayhome <- this.dat1[this.dat1$st_start==1,"svc_start"]
lfdh <- length(firstdayhome)
if (lfdh > 0)
patient_daily.df[patient_daily.df$caldate %in% firstdayhome[lfdh]:(min(firstdayhome[lfdh]+29,lastdate)), "newhpn"] <- 1
}
if (length(this.dat2$mrn)>0)
for(cvcinsert in this.dat2$insert_date){
n <- length(this.dat2[this.dat2$insert_date==cvcinsert,'remove'] == 1)
if (n > 1) {
warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same line insert date:",
as.Date(cvcinsert,"1970-01-01") ))
return( NULL )
}
else if (this.dat2[this.dat2$insert_date==cvcinsert,"remove"]==1) {
cvcremove <- this.dat2[this.dat2$insert_date==cvcinsert,"remove_date"]
if (this.dat2[this.dat2$insert_date==cvcinsert, "remove_type___clabsi"]==1)
patient_daily.df[patient_daily.df$caldate==cvcremove, "remclabsi"] <- 1
}
else cvcremove <- lastdate
patient_daily.df[patient_daily.df$caldate %in% cvcinsert:cvcremove,"centline"] <- 1
}
if (length(this.dat3$mrn)>0)
for(admitdate in this.dat3$hosp_admitdt){
n <- length(this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_discharge"]==1)
if (n > 1) {
warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same hospital admit date:",
as.Date(admitdate,"1970-01-01") ))
return( NULL )
}
else if (this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_discharge"]==1)
dischargedate <- this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_dischargedt"]
else dischargedate <- lastdate
patient_daily.df[patient_daily.df$caldate %in% admitdate:dischargedate,"nothosp"] <- 0
patient_daily.df[patient_daily.df$caldate==admitdate,"admit"] <- 1
}
if (length(this.dat4$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat4$bcx_date,"bloodinf"] <- 1
if (length(this.dat5$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat5$liver_date,"liver"] <- 1
for (mrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(mrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
save.image("J:/Analytics Projects/Home Parenteral Nutrition QI/Data/Jan 4 2018 Export/HPN_akshith.RData")
all_patients_daily.df <<- all_patients_daily.df
View(all_patients_daily.df)
save.image("J:/Analytics Projects/Home Parenteral Nutrition QI/Data/Jan 4 2018 Export/HPN_akshith.RData")
return(patient_daily.df)
View(patient_daily.df)
describe(patient_daily.df)
summarise(patient_daily.df)
View(central_line.df)
View(active.df)
View(liver.df)
View(liver.df)
View(inpatients.df)
View(inpatients.df)
View(blood_infections.df)
View(demog.df)
View(demog.df)
View(central_line.df)
View(inpatients.df)
View(growth.df)
View(outpatients.df)
rm(targetmrn) # targetmrn = 352
targetmrn = 352
if (length(this.dat5$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat5$liver_date,"liver"] <- 1
mrn
mrn = 352
all_patients_daily.df <- data.frame(mrn=numeric(),caldate=as.Date(integer(),"1970-01-01"),isactive=integer(),newhpn=integer(),
admit=integer(),centline=integer(),nothosp=integer(),bloodinf=integer(),liver=integer(),
death=integer(),transfer=integer(),weanoff=integer(),remclabsi=integer())
for (mrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(mrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
View(all_patients_daily.df)
describe(all_patients_daily.df)
for (targetmrn in demog.df$mrn)
x <- make_patient_daily_dataframe(targetmrn)
if (is.null(x)) next
for (targetmrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(targetmrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
all_patients_daily.df <<- all_patients_daily.df
describe(all_patients_daily.df)
make_all_patients_daily_dataframe()
describe(all_patients_daily.df)
make_patient_daily_dataframe<- function(targetmrn) {
# this.dat1 <- active.dat[active.dat$active_mrn==targetmrn,]
# this.dat2 <- cl.dat[cl.dat$cvc_mrn==targetmrn,]
# this.dat3 <- hosp.dat[hosp.dat$inpt_mrn==targetmrn,]
# this.dat4 <- blood.dat[blood.dat$bld_mrn==targetmrn & blood.dat$bcx_site==1 & blood.dat$clabsi_commun==1,]
this.dat1 <- active.df[active.df$mrn==targetmrn,]
this.dat2 <- central_line.df[central_line.df$mrn==targetmrn,]
this.dat3 <- inpatients.df[inpatients.df$mrn==targetmrn,]
this.dat4 <- blood_infections.df[blood_infections.df$mrn==targetmrn &
blood_infections.df$bcx_site==1 &
blood_infections.df$clabsi_commun==1,]
this.dat5 <- liver.df[liver.df$mrn==targetmrn,]
this.dat6 <- growth.df[growth.df$mrn==targetmrn,]
this.dat7 <- outpatients.df[outpatients.df$mrn==targetmrn,]
# firstdate <- min(this.dat1$svc_start,this.dat2$insert_date,this.dat3$hosp_admitdt,this.dat4$bcx_date,na.rm=T) --reciprocating the above variables in this below
firstdate <- min(this.dat1$svc_start,this.dat2$insert_date,this.dat3$hosp_admitdt,this.dat4$bcx_date,this.dat5$liver_date,na.rm=T)
if(!exists("data_export_date"))   stop( "data_export_date does not exist.")
else if (is.na(data_export_date)) stop("data_export_date is NA.")
lastdate <- data_export_date
ndays <- lastdate - firstdate + 1
if (ndays < 1) return( NULL )
caldate <- firstdate:lastdate
patient_daily.df <- data.frame(mrn=targetmrn,caldate=as.Date(caldate,"1970-01-01"),
isactive=0,newhpn=0,admit=0,centline=0,nothosp=1,bloodinf=0,liver=0,
death=0,transfer=0,weanoff=0,remclabsi=0)
## if (length(this.dat1$active_mrn)>0) {
# if (length(this.dat1$mrn)>0) {
#         for (svcstart in this.dat1$svc_start) {
#                 n <- length(this.dat1[this.dat1$svc_start==svcstart,"active_current"]==0)
#                 if (n > 1) {
#                         warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same service start date:",
#                                       as.Date(svcstart,"1970-01-01") ))
#                         return( NULL )
#                 }
#                 if (this.dat1[this.dat1$svc_start==svcstart,"active_current"]==0) {
#
#                         svcstop <- this.dat1[this.dat1$svc_start==svcstart,"svc_stop"]
#
#                         if (!is.na(this.dat1[this.dat1$svc_start==svcstart, "end_type"])) {
#
#                         if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==1)
#                                 patient_daily.df[patient_daily.df$caldate==svcstop, "transfer"] <- 1
#
#                         else if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==2)
#                                 patient_daily.df[patient_daily.df$caldate==svcstop, "weanoff"] <- 1
#
#                         else if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==4)
#                                 patient_daily.df[patient_daily.df$caldate==svcstop, "death"] <- 1
#                         }
#                 }
#                 else svcstop <- lastdate
#                 patient_daily.df[patient_daily.df$caldate %in% svcstart:svcstop,"isactive"] <- 1
#         }
#
#         firstdayhome <- this.dat1[this.dat1$st_start==1,"svc_start"]
#         lfdh <- length(firstdayhome)
#         if (lfdh > 0)
#                 patient_daily.df[patient_daily.df$caldate %in% firstdayhome[lfdh]:(min(firstdayhome[lfdh]+29,lastdate)), "newhpn"] <- 1
# }
#
# ## if (length(this.dat2$cvc_mrn)>0)
# if (length(this.dat2$mrn)>0)
#         for(cvcinsert in this.dat2$insert_date){
#                 n <- length(this.dat2[this.dat2$insert_date==cvcinsert,'remove'] == 1)
#                 if (n > 1) {
#                         warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same line insert date:",
#                                       as.Date(cvcinsert,"1970-01-01") ))
#                         return( NULL )
#                 }
#                 else if (this.dat2[this.dat2$insert_date==cvcinsert,"remove"]==1) {
#                         cvcremove <- this.dat2[this.dat2$insert_date==cvcinsert,"remove_date"]
#
#                         if (this.dat2[this.dat2$insert_date==cvcinsert, "remove_type___clabsi"]==1)
#                                 patient_daily.df[patient_daily.df$caldate==cvcremove, "remclabsi"] <- 1
#                 }
#                 else cvcremove <- lastdate
#                 patient_daily.df[patient_daily.df$caldate %in% cvcinsert:cvcremove,"centline"] <- 1
#         }
#
# ## if (length(this.dat3$inpt_mrn)>0)
# if (length(this.dat3$mrn)>0)
#         for(admitdate in this.dat3$hosp_admitdt){
#                 n <- length(this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_discharge"]==1)
#                 if (n > 1) {
#                         warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same hospital admit date:",
#                                       as.Date(admitdate,"1970-01-01") ))
#                         return( NULL )
#                 }
#                 else if (this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_discharge"]==1)
#                         dischargedate <- this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_dischargedt"]
#                 else dischargedate <- lastdate
#                 patient_daily.df[patient_daily.df$caldate %in% admitdate:dischargedate,"nothosp"] <- 0
#                 patient_daily.df[patient_daily.df$caldate==admitdate,"admit"] <- 1
#         }
#
# ## if (length(this.dat4$bld_mrn)>0)
# if (length(this.dat4$mrn)>0)
#   patient_daily.df[patient_daily.df$caldate %in% this.dat4$bcx_date,"bloodinf"] <- 1
if (length(this.dat5$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat5$liver_date,"liver"] <- 1
#
#
return(patient_daily.df)
# describe(patient_daily.df) # description of data frame values
}
make_all_patients_daily_dataframe <- function() {
if(!exists("data_export_date"))
stop("data_export_date does not exist.")
else if (is.na(data_export_date))
stop("data_export_date is NA")
all_patients_daily.df <- data.frame(mrn=numeric(),caldate=as.Date(integer(),"1970-01-01"),isactive=integer(),newhpn=integer(),
admit=integer(),centline=integer(),nothosp=integer(),bloodinf=integer(),liver=integer(),
death=integer(),transfer=integer(),weanoff=integer(),remclabsi=integer())
# for (mrn in demog.dat$mrn) { #changing dat to df
# for (mrn in demog.df$mrn) { #changing mrn to targetmrn
for (mrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(mrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
all_patients_daily.df <<- all_patients_daily.df
}
make_all_patients_daily_dataframe()
describe(all_patients_daily.df)
save.image("J:/Analytics Projects/Home Parenteral Nutrition QI/Data/Jan 4 2018 Export/HPN_akshith.RData")
data=read.csv('NEW2HomePNDatabaseAL_DATA_2018-01-04_1545_liver.csv')
label(data$mrn)="BCH Medical Record Number"
label(data$redcap_repeat_instrument)="Repeat Instrument"
label(data$redcap_repeat_instance)="Repeat Instance"
label(data$liver_date)="Date of measurement"
label(data$liver_time)="Time of measurement"
label(data$inr_rge)="Exact INR value known?"
label(data$inr_val)="INR (value)"
label(data$ggtp_rge)="GGTP (range)"
label(data$ggtp_unitl)="GGTP (value)"
label(data$ast_rge)="AST (range)"
label(data$ast_unitl)="AST (value)"
label(data$alt_rge)="ALT (range)"
label(data$alt_unitl)="ALT (value)"
label(data$dbili_rge)="Direct Bilirubin (range)"
label(data$dbili_mgdl)="Direct Bilirubin (value)"
label(data$tbili_rge)="Total Bilirubin (range)"
label(data$tbili_gdl)="Total Bilirubin (value)"
label(data$trigf_mgdl)="Triglycerides - fasting (value)"
label(data$trig_mgdl)="Triglycerides - non-fasting (value)"
label(data$cholf_mgdl)="Cholesterol - fasting (value)"
label(data$chol_mgdl)="Cholesterol - non-fasting (value)"
label(data$hdlf_mgdl)="HDL - fasting (value)"
label(data$hdl_mgdl)="HDL - non-fasting (value)"
label(data$ldlf_mgdl)="LDL - fasting (value)"
label(data$ldl_mgdl)="LDL - non-fasting (value)"
label(data$vldl_mgdl)="VLDL - fasting (value)"
label(data$crp_rge)="CRP (range)"
label(data$crp_mgdl)="CRP (value)"
label(data$mead_nmolml)="Mead Acid Level"
label(data$ttratio)="T/T Ratio"
label(data$platelet)="Platelets"
label(data$alkphos)="Alkaline phosphatase"
label(data$epa)="EPA,C20:5w3"
label(data$dha)="DHA,C22:6w3"
label(data$arachacid)="Arachidonic Acid,C20:4w6"
label(data$alinoacid)="a-Linolenic Acid,C18:3w3"
label(data$linoacid)="Linoleic Acid,C18:2w6"
label(data$liver_disease_complete)="Complete?"
#Setting Units
#Setting Factors(will create new variable for factors)
data$redcap_repeat_instrument.factor = factor(data$redcap_repeat_instrument,levels=c("active_on_service","central_line","inpatient_encounters","bloodstream_infections","nutrition_intake","growth_data","liver_disease","outpatient_encounters","interventions"))
data$inr_rge.factor = factor(data$inr_rge,levels=c("1","2","3","-8"))
data$ggtp_rge.factor = factor(data$ggtp_rge,levels=c("1","2","-8"))
data$ast_rge.factor = factor(data$ast_rge,levels=c("1","2","-8"))
data$alt_rge.factor = factor(data$alt_rge,levels=c("1","2","-8"))
data$dbili_rge.factor = factor(data$dbili_rge,levels=c("1","2","-8"))
data$tbili_rge.factor = factor(data$tbili_rge,levels=c("1","2","-8"))
data$crp_rge.factor = factor(data$crp_rge,levels=c("1","2","-8"))
data$liver_disease_complete.factor = factor(data$liver_disease_complete,levels=c("0","1","2"))
levels(data$redcap_repeat_instrument.factor)=c("Active On Service","Central Line","Inpatient Encounters","Bloodstream Infections","Nutrition Intake","Growth Data","Liver Disease","Outpatient Encounters","Interventions")
levels(data$inr_rge.factor)=c("Yes","<  1.00",">10.00","N/A")
levels(data$ggtp_rge.factor)=c("<  3","≥ 3","N/A")
levels(data$ast_rge.factor)=c("<  5","≥ 5","N/A")
levels(data$alt_rge.factor)=c("<  5","≥ 5","N/A")
levels(data$dbili_rge.factor)=c("<  0.1","≥ 0.1","N/A")
levels(data$tbili_rge.factor)=c("< 0.1","≥ 0.1","N/A")
levels(data$crp_rge.factor)=c("< 0.03","≥ 0.03","N/A")
levels(data$liver_disease_complete.factor)=c("Incomplete","Unverified","Complete")
data <- filter(data, data$redcap_repeat_instrument!="")
data$liver_date <- as.Date(data$liver_date)
liver.df <- data
rm(data)
data=read.csv('NEW2HomePNDatabaseAL_DATA_2018-01-04_1541_growth.csv')
label(data$mrn)="BCH Medical Record Number"
label(data$redcap_repeat_instrument)="Repeat Instrument"
label(data$redcap_repeat_instance)="Repeat Instance"
label(data$growth_date)="Date of measurement"
label(data$growth_time)="Time of measurement"
label(data$growth_inpt_outpt)="Type of visit"
label(data$growth_ht_cm)="Height (cm)"
label(data$growth_wt_kg)="Weight (kg)"
label(data$growth_data_complete)="Complete?"
data$redcap_repeat_instrument.factor = factor(data$redcap_repeat_instrument,levels=c("active_on_service","central_line","inpatient_encounters","bloodstream_infections","nutrition_intake","growth_data","liver_disease","outpatient_encounters","interventions"))
data$growth_inpt_outpt.factor = factor(data$growth_inpt_outpt,levels=c("1","2"))
data$growth_data_complete.factor = factor(data$growth_data_complete,levels=c("0","1","2"))
levels(data$redcap_repeat_instrument.factor)=c("Active On Service","Central Line","Inpatient Encounters","Bloodstream Infections","Nutrition Intake","Growth Data","Liver Disease","Outpatient Encounters","Interventions")
levels(data$growth_inpt_outpt.factor)=c("Inpatient","Outpatient")
levels(data$growth_data_complete.factor)=c("Incomplete","Unverified","Complete")
data <- filter(data, data$redcap_repeat_instrument!="")
data$growth_date <- as.Date(data$growth_date)
growth.df <- data
rm(data)
data=read.csv('NEW2HomePNDatabaseAL_DATA_2018-01-04_1554_outpatients.csv')
label(data$mrn)="BCH Medical Record Number"
label(data$redcap_repeat_instrument)="Repeat Instrument"
label(data$redcap_repeat_instance)="Repeat Instance"
label(data$outpt_date)="Date of encounter"
label(data$outpt_time)="Time of encounter"
label(data$clinic_id)="In what clinic was patient seen?"
label(data$clinic_id_oth)="What is the name of the other clinic?"
label(data$dx_code)="Primary billing diagnosis code"
label(data$dx_desc)="Diagnosis description"
label(data$provider)="Billing provider"
label(data$outpatient_encounters_complete)="Complete?"
#Setting Units
#Setting Factors(will create new variable for factors)
data$redcap_repeat_instrument.factor = factor(data$redcap_repeat_instrument,levels=c("active_on_service","central_line","inpatient_encounters","bloodstream_infections","nutrition_intake","growth_data","liver_disease","outpatient_encounters","interventions"))
data$clinic_id.factor = factor(data$clinic_id,levels=c("1","2","999"))
data$outpatient_encounters_complete.factor = factor(data$outpatient_encounters_complete,levels=c("0","1","2"))
levels(data$redcap_repeat_instrument.factor)=c("Active On Service","Central Line","Inpatient Encounters","Bloodstream Infections","Nutrition Intake","Growth Data","Liver Disease","Outpatient Encounters","Interventions")
levels(data$clinic_id.factor)=c("Home PN program","CAIR","Other")
levels(data$outpatient_encounters_complete.factor)=c("Incomplete","Unverified","Complete")
data <- filter(data, data$redcap_repeat_instrument!="")
data$outpt_date <- as.Date(data$outpt_date)
outpatients.df <- data
rm(data)
rm(targetmrn)
rm(firstdate)
rm(firstdayhome)
rm(x)
make_patient_daily_dataframe<- function(targetmrn) {
# this.dat1 <- active.dat[active.dat$active_mrn==targetmrn,]
# this.dat2 <- cl.dat[cl.dat$cvc_mrn==targetmrn,]
# this.dat3 <- hosp.dat[hosp.dat$inpt_mrn==targetmrn,]
# this.dat4 <- blood.dat[blood.dat$bld_mrn==targetmrn & blood.dat$bcx_site==1 & blood.dat$clabsi_commun==1,]
this.dat1 <- active.df[active.df$mrn==targetmrn,]
this.dat2 <- central_line.df[central_line.df$mrn==targetmrn,]
this.dat3 <- inpatients.df[inpatients.df$mrn==targetmrn,]
this.dat4 <- blood_infections.df[blood_infections.df$mrn==targetmrn &
blood_infections.df$bcx_site==1 &
blood_infections.df$clabsi_commun==1,]
this.dat5 <- liver.df[liver.df$mrn==targetmrn,]
this.dat6 <- growth.df[growth.df$mrn==targetmrn,]
this.dat7 <- outpatients.df[outpatients.df$mrn==targetmrn,]
# firstdate <- min(this.dat1$svc_start,this.dat2$insert_date,this.dat3$hosp_admitdt,this.dat4$bcx_date,na.rm=T) --reciprocating the above variables in this below
firstdate <- min(this.dat1$svc_start,this.dat2$insert_date,this.dat3$hosp_admitdt,this.dat4$bcx_date,this.dat5$liver_date,na.rm=T)
if(!exists("data_export_date"))   stop( "data_export_date does not exist.")
else if (is.na(data_export_date)) stop("data_export_date is NA.")
lastdate <- data_export_date
ndays <- lastdate - firstdate + 1
if (ndays < 1) return( NULL )
caldate <- firstdate:lastdate
patient_daily.df <- data.frame(mrn=targetmrn,caldate=as.Date(caldate,"1970-01-01"),
isactive=0,newhpn=0,admit=0,centline=0,nothosp=1,bloodinf=0,liver=0, growth=0, outpatient=0,
death=0,transfer=0,weanoff=0,remclabsi=0)
## if (length(this.dat1$active_mrn)>0) {
if (length(this.dat1$mrn)>0) {
for (svcstart in this.dat1$svc_start) {
n <- length(this.dat1[this.dat1$svc_start==svcstart,"active_current"]==0)
if (n > 1) {
warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same service start date:",
as.Date(svcstart,"1970-01-01") ))
return( NULL )
}
if (this.dat1[this.dat1$svc_start==svcstart,"active_current"]==0) {
svcstop <- this.dat1[this.dat1$svc_start==svcstart,"svc_stop"]
if (!is.na(this.dat1[this.dat1$svc_start==svcstart, "end_type"])) {
if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==1)
patient_daily.df[patient_daily.df$caldate==svcstop, "transfer"] <- 1
else if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==2)
patient_daily.df[patient_daily.df$caldate==svcstop, "weanoff"] <- 1
else if (this.dat1[this.dat1$svc_start==svcstart, "end_type"]==4)
patient_daily.df[patient_daily.df$caldate==svcstop, "death"] <- 1
}
}
else svcstop <- lastdate
patient_daily.df[patient_daily.df$caldate %in% svcstart:svcstop,"isactive"] <- 1
}
firstdayhome <- this.dat1[this.dat1$st_start==1,"svc_start"]
lfdh <- length(firstdayhome)
if (lfdh > 0)
patient_daily.df[patient_daily.df$caldate %in% firstdayhome[lfdh]:(min(firstdayhome[lfdh]+29,lastdate)), "newhpn"] <- 1
}
## if (length(this.dat2$cvc_mrn)>0)
if (length(this.dat2$mrn)>0)
for(cvcinsert in this.dat2$insert_date){
n <- length(this.dat2[this.dat2$insert_date==cvcinsert,'remove'] == 1)
if (n > 1) {
warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same line insert date:",
as.Date(cvcinsert,"1970-01-01") ))
return( NULL )
}
else if (this.dat2[this.dat2$insert_date==cvcinsert,"remove"]==1) {
cvcremove <- this.dat2[this.dat2$insert_date==cvcinsert,"remove_date"]
if (this.dat2[this.dat2$insert_date==cvcinsert, "remove_type___clabsi"]==1)
patient_daily.df[patient_daily.df$caldate==cvcremove, "remclabsi"] <- 1
}
else cvcremove <- lastdate
patient_daily.df[patient_daily.df$caldate %in% cvcinsert:cvcremove,"centline"] <- 1
}
## if (length(this.dat3$inpt_mrn)>0)
if (length(this.dat3$mrn)>0)
for(admitdate in this.dat3$hosp_admitdt){
n <- length(this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_discharge"]==1)
if (n > 1) {
warning(paste("OMITTING mrn",targetmrn, "because found", n, "records for same hospital admit date:",
as.Date(admitdate,"1970-01-01") ))
return( NULL )
}
else if (this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_discharge"]==1)
dischargedate <- this.dat3[this.dat3$hosp_admitdt==admitdate,"hosp_dischargedt"]
else dischargedate <- lastdate
patient_daily.df[patient_daily.df$caldate %in% admitdate:dischargedate,"nothosp"] <- 0
patient_daily.df[patient_daily.df$caldate==admitdate,"admit"] <- 1
}
## if (length(this.dat4$bld_mrn)>0)
if (length(this.dat4$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat4$bcx_date,"bloodinf"] <- 1
if (length(this.dat5$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat5$liver_date,"liver"] <- 1
if (length(this.dat6$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat5$growth_date,"growth"] <- 1
if (length(this.dat7$mrn)>0)
patient_daily.df[patient_daily.df$caldate %in% this.dat5$outpt_date,"outpatient"] <- 1
#
#
return(patient_daily.df)
# describe(patient_daily.df) # description of data frame values
}
make_all_patients_daily_dataframe <- function() {
if(!exists("data_export_date"))
stop("data_export_date does not exist.")
else if (is.na(data_export_date))
stop("data_export_date is NA")
all_patients_daily.df <- data.frame(mrn=numeric(),caldate=as.Date(integer(),"1970-01-01"),isactive=integer(),newhpn=integer(),
admit=integer(),centline=integer(),nothosp=integer(),bloodinf=integer(),liver=integer(), growth=integer(), outpatient==integer(),
death=integer(),transfer=integer(),weanoff=integer(),remclabsi=integer())
# for (mrn in demog.dat$mrn) { #changing dat to df
# for (mrn in demog.df$mrn) { #changing mrn to targetmrn
for (mrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(mrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
all_patients_daily.df <<- all_patients_daily.df
}
data_export_date <- as.Date("2017-01-30")
make_all_patients_daily_dataframe()
all_patients_daily.df <- data.frame(mrn=numeric(),caldate=as.Date(integer(),"1970-01-01"),isactive=integer(),newhpn=integer(),
admit=integer(),centline=integer(),nothosp=integer(),bloodinf=integer(),liver=integer(), growth=integer(), outpatient=integer(),
death=integer(),transfer=integer(),weanoff=integer(),remclabsi=integer())
make_all_patients_daily_dataframe <- function() {
if(!exists("data_export_date"))
stop("data_export_date does not exist.")
else if (is.na(data_export_date))
stop("data_export_date is NA")
all_patients_daily.df <- data.frame(mrn=numeric(),caldate=as.Date(integer(),"1970-01-01"),isactive=integer(),newhpn=integer(),
admit=integer(),centline=integer(),nothosp=integer(),bloodinf=integer(),liver=integer(), growth=integer(), outpatient=integer(),
death=integer(),transfer=integer(),weanoff=integer(),remclabsi=integer())
# for (mrn in demog.dat$mrn) { #changing dat to df
# for (mrn in demog.df$mrn) { #changing mrn to targetmrn
for (mrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(mrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
all_patients_daily.df <<- all_patients_daily.df
}
make_all_patients_daily_dataframe <- function() {
if(!exists("data_export_date"))
stop("data_export_date does not exist.")
else if (is.na(data_export_date))
stop("data_export_date is NA")
all_patients_daily.df <- data.frame(mrn=numeric(),caldate=as.Date(integer(),"1970-01-01"),isactive=integer(),newhpn=integer(),
admit=integer(),centline=integer(),nothosp=integer(),bloodinf=integer(),liver=integer(), growth=integer(), outpatient=integer(),
death=integer(),transfer=integer(),weanoff=integer(),remclabsi=integer())
# for (mrn in demog.dat$mrn) { #changing dat to df
# for (mrn in demog.df$mrn) { #changing mrn to targetmrn
for (mrn in demog.df$mrn) {
x <- make_patient_daily_dataframe(mrn)
if (is.null(x)) next
else all_patients_daily.df <- rbind(all_patients_daily.df,x)
}
all_patients_daily.df <<- all_patients_daily.df
}
make_all_patients_daily_dataframe()
save.image("J:/Analytics Projects/Home Parenteral Nutrition QI/Data/Jan 4 2018 Export/HPN_akshith.RData")
